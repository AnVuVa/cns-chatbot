# cns-chatbot-api
PHẦN 1: README.md
Bạn hãy tạo file README.md ở thư mục gốc và dán nội dung sau vào. Tài liệu này hướng dẫn chi tiết từ việc lấy API Key đến chạy database.

Markdown

# Enterprise Self-Learning Hybrid Chatbot (Backend)

Hệ thống Chatbot doanh nghiệp sử dụng kiến trúc Hybrid (RAG + AI Router), kết hợp giữa Google Gemini và 1minAI (GPT-4o), hỗ trợ tự động học hỏi và tối ưu chi phí.

## 1. Yêu cầu hệ thống
- Node.js v18 trở lên.
- Tài khoản [Supabase](https://supabase.com) (Database & Vector Store).
- Tài khoản [Upstash](https://upstash.com) (Redis Cache).
- API Key từ [Google AI Studio](https://aistudio.google.com/) (Gemini).
- API Key từ [1min.ai](https://1min.ai/).

## 2. Cài đặt

Clone dự án và cài đặt dependencies:

```bash
git clone <your-repo-url>
cd enterprise-chatbot-backend
npm install
3. Cấu hình Environment (.env)
Tạo file .env tại thư mục gốc và điền các thông tin sau:

Đoạn mã

PORT=3000

# SUPABASE (Database & Vector)
# Lấy tại: Supabase Dashboard -> Project Settings -> API
SUPABASE_URL=[https://your-project-id.supabase.co](https://your-project-id.supabase.co)
SUPABASE_KEY=your-anon-key-here

# UPSTASH (Redis Cache)
# Lấy tại: Upstash Console -> Redis -> Details (REST API)
UPSTASH_REDIS_REST_URL=[https://your-redis-url.upstash.io](https://your-redis-url.upstash.io)
UPSTASH_REDIS_REST_TOKEN=your-redis-token-here

# AI PROVIDERS
# Lấy tại: [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
GEMINI_API_KEY=AIzaSy...
# Lấy tại: [https://1min.ai/user/api](https://1min.ai/user/api)
ONEMIN_API_KEY=your-1min-api-key
4. Thiết lập Database (Supabase)
Truy cập SQL Editor trong Supabase Dashboard và chạy đoạn script sau để tạo bảng và hàm tìm kiếm Vector (Lưu ý: Vector size 768 cho Gemini):

SQL

-- 1. Kích hoạt Vector Extension
create extension if not exists vector;

-- 2. Bảng phiên chat
create table chat_sessions (
  id uuid primary key default gen_random_uuid(),
  user_id varchar not null,
  metadata jsonb,
  created_at timestamptz default now()
);

-- 3. Bảng tri thức (Knowledge Base)
create table knowledge_base (
  id bigint generated by default as identity primary key,
  content text not null,
  embedding vector(768), -- Kích thước vector của Gemini Text-Embedding-004
  source_type varchar(50),
  metadata jsonb default '{}'::jsonb,
  is_active boolean default true
);

-- 4. Bảng lịch sử chat (Logs)
create table chat_logs (
  id bigint generated by default as identity primary key,
  session_id uuid references chat_sessions(id),
  user_question text,
  bot_response text,
  provider varchar,
  latency_ms int,
  cost_estimated float,
  handled_by_layer int,
  processed_for_learning boolean default false,
  created_at timestamptz default now()
);

-- 5. Hàm tìm kiếm Vector (Quan trọng)
create or replace function match_documents (
  query_embedding vector(768),
  match_threshold float,
  match_count int
)
returns table (
  id bigint,
  content text,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    knowledge_base.id,
    knowledge_base.content,
    1 - (knowledge_base.embedding <=> query_embedding) as similarity
  from knowledge_base
  where 1 - (knowledge_base.embedding <=> query_embedding) > match_threshold
  order by similarity desc
  limit match_count;
end;
$$;
5. Nạp dữ liệu tri thức (Ingestion)
Tạo thư mục knowledge_data ở gốc dự án.

Copy các file tài liệu (.txt, .pdf, .docx, .md) vào thư mục này.

Chạy script để cắt nhỏ file và tạo vector:

Bash

# Đảm bảo đã thêm script này vào package.json hoặc chạy trực tiếp:
node scripts/ingest-text.js
6. Khởi chạy Server
Chạy server ở chế độ development (tự động restart khi sửa code):

Bash

npx nodemon src/server.js
Server sẽ chạy tại: http://localhost:3000

7. Sử dụng API
REST API
Endpoint: POST /api/chat/message

Body:

JSON

{
  "userId": "user_123",
  "question": "Quy trình đổi trả hàng?"
}
WebSocket (Socket.io)
Event connect: join_room (gửi sessionId)

Event send: send_message (gửi { userId, sessionId, question })

Event receive: receive_message


---

### PHẦN 2: CẬP NHẬT PACKAGE.JSON
Để thuận tiện cho việc chạy lệnh, bạn hãy mở file `package.json` và bổ sung phần `scripts`:

```json
  "scripts": {
    "start": "node src/server.js",
    "dev": "nodemon src/server.js",
    "ingest": "node scripts/ingest-text.js",
    "learn": "node scripts/daily-learning-job.js"
  },
Sau này bạn chỉ cần gõ npm run ingest hoặc npm run dev.

PHẦN 3: POSTMAN COLLECTION (JSON)
Dưới đây là mã JSON để Import vào Postman. Cách dùng:

Copy nội dung bên dưới.

Lưu thành file chatbot_api.postman_collection.json.

Mở Postman -> Nút Import -> Kéo thả file này vào.

JSON

{
	"info": {
		"_postman_id": "b6a7b3c2-1234-4567-8910-abcdef123456",
		"name": "Enterprise Hybrid Chatbot API",
		"description": "Collection test API cho hệ thống Chatbot Hybrid (RAG + 1minAI/Gemini)",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
		"_exporter_id": "1234567"
	},
	"item": [
		{
			"name": "Chat Message (REST)",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"userId\": \"test_user_01\",\n    \"question\": \"Bạn có thể làm thơ lục bát không?\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/chat/message",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"chat",
						"message"
					]
				},
				"description": "Gửi tin nhắn chat tới Bot.\n\nPayload:\n- userId: ID người dùng (dùng để định tuyến).\n- question: Câu hỏi.\n- sessionId (Optional): Nếu không gửi, server tự tạo mới."
			},
			"response": []
		},
		{
			"name": "Chat Message (With Session)",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"userId\": \"test_user_01\",\n    \"sessionId\": \"<PASTE_SESSION_ID_HERE>\",\n    \"question\": \"Quy trình bảo hành thế nào?\"\n}"
				},
				"url": {
					"raw": "{{base_url}}/api/chat/message",
					"host": [
						"{{base_url}}"
					],
					"path": [
						"api",
						"chat",
						"message"
					]
				},
				"description": "Tiếp tục hội thoại cũ bằng cách gửi kèm sessionId."
			},
			"response": []
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		},
		{
			"listen": "test",
			"script": {
				"type": "text/javascript",
				"exec": [
					""
				]
			}
		}
	],
	"variable": [
		{
			"key": "base_url",
			"value": "http://localhost:3000",
			"type": "string"
		}
	]
}
Lời khuyên cuối cùng
Nếu bạn muốn test tính năng Socket.io trên Postman (phiên bản mới nhất đã hỗ trợ):

Chọn New -> WebSocket Request.

Nhập URL: ws://localhost:3000.

Tab Message, nhập JSON: 42["join_room", "session-id-demo"] (Format của Socket.io hơi đặc thù, nên test bằng Client JS hoặc trang Firecamp sẽ dễ hơn Postman cho WebSocket).