# ğŸ¤– Enterprise Self-Learning Hybrid Chatbot

![Node.js](https://img.shields.io/badge/Node.js-v18+-green)
![Supabase](https://img.shields.io/badge/Database-Supabase%20(pgvector)-3ECF8E)
![Redis](https://img.shields.io/badge/Cache-Upstash%20Redis-red)
![AI](https://img.shields.io/badge/AI-Gemini%20%2B%20GPT4o%20(1min)-blue)

Há»‡ thá»‘ng **Backend Chatbot doanh nghiá»‡p hiá»‡u nÄƒng cao**, sá»­ dá»¥ng kiáº¿n trÃºc **Hybrid RAG** (Retrieval-Augmented Generation). Há»‡ thá»‘ng káº¿t há»£p sá»©c máº¡nh tÃ¬m kiáº¿m **Vector**, bá»™ nhá»› Ä‘á»‡m **Redis** vÃ  cÆ¡ cháº¿ **Ä‘á»‹nh tuyáº¿n AI thÃ´ng minh (AI Router)** Ä‘á»ƒ tá»‘i Æ°u hÃ³a chi phÃ­ vÃ  Ä‘á»™ chÃ­nh xÃ¡c.

## ğŸŒŸ TÃ­nh nÄƒng ná»•i báº­t

* **Phá»…u lá»c 4 lá»›p (4-Layer Funnel):** Tá»‘i Æ°u tá»‘c Ä‘á»™ pháº£n há»“i vÃ  chi phÃ­.
    1.  **Layer 1 (Cache & Rules):** Pháº£n há»“i tá»©c thÃ¬ (<50ms) cho cÃ¡c cÃ¢u há»i láº·p láº¡i hoáº·c xÃ£ giao.
    2.  **Layer 2 (RAG Search):** TÃ¬m kiáº¿m tri thá»©c doanh nghiá»‡p vá»›i **Strict Mode** (chá»‘ng bá»‹a Ä‘áº·t thÃ´ng tin).
    3.  **Layer 3 (AI Router):** Æ¯u tiÃªn **GPT-4o (via 1minAI)** cháº¥t lÆ°á»£ng cao, tá»± Ä‘á»™ng Fallback sang **Gemini Flash** náº¿u lá»—i.
    4.  **Layer 4 (Self-Learning):** (Batch Job) Tá»± Ä‘á»™ng há»c tá»« lá»‹ch sá»­ chat Ä‘á»ƒ cáº­p nháº­t tri thá»©c (Future release).
* **Smart Ingestion Pipeline:** Há»— trá»£ náº¡p dá»¯ liá»‡u tá»« file `.txt`, `.pdf`, `.docx`, `.md` sá»‘ lÆ°á»£ng lá»›n, tá»± Ä‘á»™ng cáº¯t nhá» (Chunking) vÃ  Vector hÃ³a.
* **Anti-Hallucination:** CÆ¡ cháº¿ Prompt Engineering nghiÃªm ngáº·t, buá»™c AI tráº£ lá»i **"TÃ´i khÃ´ng biáº¿t"** vÃ  cung cáº¥p hotline náº¿u khÃ´ng tÃ¬m tháº¥y thÃ´ng tin trong tÃ i liá»‡u.
* **Real-time:** Há»— trá»£ giao tiáº¿p qua **WebSocket (Socket.io)**.

---

## ğŸ›  YÃªu cáº§u há»‡ thá»‘ng

* **Runtime:** **Node.js v18** trá»Ÿ lÃªn.
* **Database:** TÃ i khoáº£n **[Supabase](https://supabase.com)** (PostgreSQL + pgvector).
* **Cache:** TÃ i khoáº£n **[Upstash](https://upstash.com)** (Redis Serverless).
* **AI Keys:**
    * Google **Gemini API Key** (DÃ¹ng cho Embedding & Fallback).
    * **1min.ai API Key** (DÃ¹ng cho Main Chat Model).

---

## ğŸš€ CÃ i Ä‘áº·t & Khá»Ÿi cháº¡y

### 1. Clone & Install

```bash
git clone <your-repo-url>
cd enterprise-chatbot-backend
npm install
````

### 2\. Cáº¥u hÃ¬nh Environment (`.env`)

Táº¡o file `.env` táº¡i thÆ° má»¥c gá»‘c vÃ  Ä‘iá»n Ä‘áº§y Ä‘á»§ thÃ´ng tin:

```env
PORT=3000

# SUPABASE CONFIG
SUPABASE_URL=[https://your-project-id.supabase.co](https://your-project-id.supabase.co)
SUPABASE_KEY=your-anon-key-here

# UPSTASH REDIS CONFIG
UPSTASH_REDIS_REST_URL=[https://your-redis-url.upstash.io](https://your-redis-url.upstash.io)
UPSTASH_REDIS_REST_TOKEN=your-redis-token-here

# AI PROVIDERS
# Láº¥y táº¡i: [https://aistudio.google.com/app/apikey](https://aistudio.google.com/app/apikey)
GEMINI_API_KEY=AIzaSy...
# Láº¥y táº¡i: [https://1min.ai/user/api](https://1min.ai/user/api)
ONEMIN_API_KEY=your-1min-api-key
```

### 3\. Thiáº¿t láº­p Database (Supabase SQL)

Truy cáº­p Supabase Dashboard \> **SQL Editor** vÃ  cháº¡y script sau Ä‘á»ƒ khá»Ÿi táº¡o DB vá»›i Vector size **768** (Chuáº©n cá»§a Gemini Embedding):

```sql
-- KÃ­ch hoáº¡t Vector Extension
create extension if not exists vector;

-- Báº£ng phiÃªn chat
create table chat_sessions (
  id uuid primary key default gen_random_uuid(),
  user_id varchar not null,
  metadata jsonb,
  created_at timestamptz default now()
);

-- Báº£ng tri thá»©c (Knowledge Base)
create table knowledge_base (
  id bigint generated by default as identity primary key,
  content text not null,
  embedding vector(768), -- KÃ­ch thÆ°á»›c vector text-embedding-004
  source_type varchar(50),
  metadata jsonb default '{}'::jsonb,
  is_active boolean default true
);

-- Báº£ng lá»‹ch sá»­ chat (Logs)
create table chat_logs (
  id bigint generated by default as identity primary key,
  session_id uuid references chat_sessions(id),
  user_question text,
  bot_response text,
  provider varchar,
  latency_ms int,
  cost_estimated float,
  handled_by_layer int,
  processed_for_learning boolean default false,
  created_at timestamptz default now()
);

-- HÃ m tÃ¬m kiáº¿m Vector (Match Documents)
create or replace function match_documents (
  query_embedding vector(768),
  match_threshold float,
  match_count int
)
returns table (
  id bigint,
  content text,
  similarity float
)
language plpgsql
as $$
begin
  return query
  select
    knowledge_base.id,
    knowledge_base.content,
    1 - (knowledge_base.embedding <=> query_embedding) as similarity
  from knowledge_base
  where 1 - (knowledge_base.embedding <=> query_embedding) > match_threshold
  order by similarity desc
  limit match_count;
end;
$$;
```

### ğŸ“š Quáº£n lÃ½ dá»¯ liá»‡u tri thá»©c (Ingestion)

Há»‡ thá»‘ng cung cáº¥p tool Ä‘á»ƒ tá»± Ä‘á»™ng náº¡p tÃ i liá»‡u vÃ o **Knowledge Base**.

**BÆ°á»›c 1: Táº¡o thÆ° má»¥c chá»©a dá»¯ liá»‡u:**

```bash
mkdir knowledge_data
```

**BÆ°á»›c 2: Copy file tÃ i liá»‡u** cá»§a báº¡n vÃ o thÆ° má»¥c `knowledge_data`.

> Há»— trá»£: `.pdf`, `.docx`, `.txt`, `.md`.
> NÃªn chia theo thÆ° má»¥c con Ä‘á»ƒ dá»… quáº£n lÃ½ (vÃ­ dá»¥: `knowledge_data/hr/policy.pdf`).

**BÆ°á»›c 3: Cháº¡y script náº¡p dá»¯ liá»‡u:**

```bash
npm run ingest
```

> Script sáº½ tá»± Ä‘á»™ng Ä‘á»c file, cáº¯t nhá» (chunking), táº¡o vector embedding qua **Gemini** vÃ  lÆ°u vÃ o Supabase.

### â–¶ï¸ Cháº¡y Server

**Cháº¿ Ä‘á»™ Development** (Tá»± Ä‘á»™ng restart khi sá»­a code)

```bash
npm run dev
```

**Cháº¿ Ä‘á»™ Production**

```bash
npm start
```

> Server sáº½ khá»Ÿi cháº¡y táº¡i: **http://localhost:3000**

-----

## ğŸ”Œ API Documentation

### 1\. Gá»­i tin nháº¯n (Chat Message)

  * **URL:** `POST /api/chat/message`
  * **Headers:** `Content-Type: application/json`
  * **Body:**

<!-- end list -->

```json
{
  "userId": "user_12345",
  "sessionId": "optional-session-uuid",
  "question": "Quy trÃ¬nh xin nghá»‰ phÃ©p nhÆ° tháº¿ nÃ o?"
}
```

  * **Response Success:**

<!-- end list -->

```json
{
  "sessionId": "uuid-generated-by-server",
  "answer": "Theo quy Ä‘á»‹nh, báº¡n cáº§n lÃ m Ä‘Æ¡n trÃªn há»‡ thá»‘ng ERP trÆ°á»›c 2 ngÃ y..."
}
```

### 2\. WebSocket (Real-time)

Sá»­ dá»¥ng thÆ° viá»‡n `socket.io-client`.

  * **Connect:** `ws://localhost:3000`
  * **Events:**
      * Client emit `join_room`: Gá»­i `sessionId`.
      * Client emit `send_message`: Gá»­i object `{ userId, sessionId, question }`.
      * Server emit `receive_message`: Nháº­n object `{ answer, timestamp }`.

-----

## ğŸ“‚ Cáº¥u trÃºc dá»± Ã¡n

```plaintext
enterprise-chatbot-backend/
â”œâ”€â”€ knowledge_data/        # NÆ¡i chá»©a tÃ i liá»‡u gá»‘c (PDF, Docx...)
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ ingest-text.js     # Script náº¡p dá»¯ liá»‡u (ETL)
â”‚   â””â”€â”€ daily-learning.js  # Script tá»± há»c (Cron job)
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config/            # Cáº¥u hÃ¬nh DB, Redis
â”‚   â”œâ”€â”€ controllers/       # Xá»­ lÃ½ request HTTP
â”‚   â”œâ”€â”€ providers/         # CÃ¡c Class tÃ­ch há»£p AI (Gemini, 1min)
â”‚   â”œâ”€â”€ routes/            # Äá»‹nh nghÄ©a API Endpoint
â”‚   â”œâ”€â”€ services/          # Business Logic (Chat flow, RAG, Routing)
â”‚   â”œâ”€â”€ utils/             # Tiá»‡n Ã­ch
â”‚   â”œâ”€â”€ app.js             # Express App setup
â”‚   â””â”€â”€ server.js          # Entry point (HTTP + Socket.io)
â”œâ”€â”€ .env                   # Biáº¿n mÃ´i trÆ°á»ng
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

-----

## ğŸ›¡ Disclaimer

Dá»± Ã¡n sá»­ dá»¥ng cÃ¡c **API bÃªn thá»© 3** (Google Gemini, 1min.ai). HÃ£y Ä‘áº£m báº£o tuÃ¢n thá»§ **chÃ­nh sÃ¡ch sá»­ dá»¥ng** vÃ  **háº¡n má»©c (Quota)** cá»§a cÃ¡c nhÃ  cung cáº¥p nÃ y.

```

Would you like me to elaborate on the **Hybrid RAG architecture** used in this chatbot?
```
